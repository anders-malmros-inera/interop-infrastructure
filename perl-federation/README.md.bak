# Federation membership service (perl-federation)

This service implements a minimal Federation membership API (Perl/Dancer2). It's intended as a small example of a backend service that tracks members of a federation and exposes a simple REST surface.

Key points

- Service: `perl-federation` (Perl/Dancer2, PSGI)
- Intended to be backend-only and proxied via Kong at `/federation`
- OpenAPI doc: `openapi/federation-membership-api.html` (served by the `openapi` static server and visible in the admin UI under the APIs tab)
- DB table: `members` (see `service-catalog-db/migrations/0001_create_members.sql`)

Endpoints (examples)

- GET /_ping
  - Lightweight health endpoint that returns { ok: 1, now: "..." }
- GET /members
  - Returns a JSON list of federation members (empty array if none)
- POST /members
  - Create a member, body JSON: { organizationId: "org1", name: "Member name", status: "active" }
- GET /members/:id
- PUT /members/:id
- DELETE /members/:id

How it's exposed in the compose stack

- The service is declared in `docker-compose.yml` as `federation` and is attached to the `backend` network. It is reachable inside the Compose/Kong network at `http://federation:5001`.
- Kong declarative config (`kong.yml`) maps the public path `/federation` to the upstream `http://federation:5001` and strips the prefix before proxying to the service.
- For local development the recommended access is via Kong through the public proxy:
  - Example: `http://localhost:8080/federation/_ping`
  - Example: `http://localhost:8080/federation/members`

Database notes

- The required table `members` is created by migration `service-catalog-db/migrations/0001_create_members.sql`.
- If your DB volume existed before the migration was added, run the migration helper to apply it to the running DB container:

```powershell
cd C:\dev\workspace\interop-infrastructure
.\scripts\apply-db-migrations.ps1
```

Running tests and OpenAPI

- The admin web UI lists the Federation OpenAPI under the APIs tab and serves the static OpenAPI HTML at `/openapi/federation-membership-api.html`.
- The admin-web test-runner includes federation CRUD tests and will run them when invoked via `GET /api/run-tests` (proxied via Kong at `http://localhost:8080/api/run-tests`).

Quick curl examples (via Kong)

```powershell
# ping
curl http://localhost:8080/federation/_ping

# list members
curl http://localhost:8080/federation/members

# create a member
curl -X POST http://localhost:8080/federation/members -H "Content-Type: application/json" -d '{"organizationId":"org1","name":"Test Member","status":"active"}'
```

Notes for developers

- The service code lives in `perl-federation/` and contains a Dancer2 PSGI app and a small model layer that uses DBI/DBD::Pg.
- The container image is built by the top-level `docker-compose.yml` and is intended to be backend-only; if you need to debug the service from the host you can temporarily add a `ports:` mapping in a local copy of `docker-compose.yml` (not recommended for shared setups).

Contact

If you want the service tightened (input validation, pagination, authentication) I can add example validators and tests; tell me which features you prefer.

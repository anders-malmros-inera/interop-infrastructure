services:
  db:
    build: ./service-catalog-db
    image: service-catalog-db:latest
    environment:
      POSTGRES_DB: service_catalog
      POSTGRES_USER: svcuser
      POSTGRES_PASSWORD: svcpass
    # db is backend-only; not exposed on the host when Kong is used as gateway
    networks:
      - backend
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U svcuser -d service_catalog || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build: ./perl-api
    image: perl-service-catalog:latest
    depends_on:
      - db
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: service_catalog
      DB_USER: svcuser
      DB_PASS: svcpass
    # backend-only service, no host ports (Kong will proxy to this)
    restart: unless-stopped
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/_ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  openapi:
    build: ./openapi
    image: interop-openapi:latest
    # static OpenAPI UI — DMZ-only, proxied by Kong
    restart: unless-stopped
    networks:
      - dmz

  java-api:
    build: ./java-api
    image: java-service-catalog:latest
    depends_on:
      - db
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: service_catalog
      DB_USER: svcuser
      DB_PASS: svcpass
    # backend-only service, no host ports (Kong will proxy to this)
    restart: unless-stopped
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/_ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
  federation:
    build: ./perl-federation
    image: perl-federation:latest
    depends_on:
      - db
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: service_catalog
      DB_USER: svcuser
      DB_PASS: svcpass
    restart: unless-stopped
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5001/_ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
  # keycloak service removed from compose — manage Keycloak externally if needed
  # NOTE: a second postgres service (named 'postgres') was removed to avoid confusion.
  # The single Postgres instance used by the APIs is `db` (service-catalog-db).
  # If you need a separate Postgres for other projects, add it back with a different name.

  admin-web:
    build:
      context: .
      dockerfile: admin-web/Dockerfile
    image: interop-admin-web:latest
    depends_on:
      - api
      - java-api
      - federation
    environment:
      # admin-web will call APIs through Kong (internal DNS 'kong')
      PERL_API_BASE: http://kong:8000/perl
      JAVA_API_BASE: http://kong:8000/java
      # admin-web runs on the DMZ network; use Kong proxy for federation so the UI's server-side
      # runner can reach the federation API through Kong (kong is attached to both dmz and backend).
      FED_API_BASE: http://kong:8000/federation
    # admin-web is DMZ-only; Kong will expose the UI to the host
    restart: unless-stopped
    networks:
      - dmz

  kong:
    image: kong:3.3
    container_name: interop-kong-1
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: "/usr/local/kong/declarative/kong.yml"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_PROXY_LISTEN: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
    volumes:
      - ./kong.yml:/usr/local/kong/declarative/kong.yml:ro
    ports:
      - "8080:8000"   # public HTTP proxy (mapped to host 8080)
      - "8443:8443"   # public HTTPS proxy (mapped to host 8443)
      # Kong Admin API mapping intentionally removed to avoid exposing admin API on host.
      # If you need it for local debugging, add back "8001:8001" but take care on shared machines.
    networks:
      - dmz
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:8001/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  db_data:

networks:
  dmz:
    driver: bridge
  backend:
    driver: bridge

